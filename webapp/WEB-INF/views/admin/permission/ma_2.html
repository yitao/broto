<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>模块功能管理</title>
    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <link href="${app_static}/metronic/assets/global/plugins/bootstrap-modal/css/bootstrap-modal-bs3patch.css" rel="stylesheet" type="text/css"/>
    <link href="${app_static}/metronic/assets/global/plugins/bootstrap-modal/css/bootstrap-modal.css" rel="stylesheet" type="text/css"/>
    <!-- END PAGE LEVEL PLUGINS -->
    <script src="${app_static}/metronic/assets/global/plugins/bootstrap-modal/js/bootstrap-modalmanager.js" type="text/javascript"></script>
    <script src="${app_static}/metronic/assets/global/plugins/bootstrap-modal/js/bootstrap-modal.js" type="text/javascript"></script>

</head>
<body>
<div class="row">
    <div class="col-md-6">
        <div class="portlet box grey-cascade">
            <div class="portlet-title">
                <div class="caption">
                    <i class="fa fa-globe"></i>模块编辑
                </div>
            </div>
            <div class="portlet-body">
                <div class="table-toolbar">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="btn-group">
                                <button id="add_module" class="btn green">
                                    添加 <i class="fa fa-plus"></i>
                                </button>
                                <button id="update_module" class="btn green">
                                    更新 <i class="fa fa-plus"></i>
                                </button>
                                <button id="delete_module" class="btn green">
                                    删除 <i class="fa fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-scrollable">
                    <table class="table table-striped table-bordered table-hover dataTable no-footer"
                           id="moduleDataTable"
                           aria-describedby="datatable_ajax_info" role="grid">
                        <thead>
                        <tr role="row" class="heading">
                            <th width="50%">
                                模块名称
                            </th>
                            <th width="50%">
                                排序值
                            </th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <div class="col-md-6">
        <div class="portlet box grey-cascade">
            <div class="portlet-title">
                <div class="caption">
                    <i class="fa fa-globe"></i>动作编辑
                </div>
            </div>
            <div class="portlet-body">
                <div class="table-toolbar">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="btn-group">
                                <button id="add_action" class="btn green">
                                    添加 <i class="fa fa-plus"></i>
                                </button>
                                <button id="update_action" class="btn green">
                                    更新 <i class="fa fa-plus"></i>
                                </button>
                                <button id="delete_action" class="btn green">
                                    删除 <i class="fa fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-scrollable">
                    <table class="table table-striped table-bordered table-hover dataTable no-footer"
                           id="actionDataTable"
                           aria-describedby="datatable_ajax_info" role="grid">
                        <thead>
                        <tr role="row" class="heading">
                            <th width="20%">
                                动作名称
                            </th>
                            <th width="20%">
                                动作地址
                            </th>
                            <th width="20%">
                                动作描述
                            </th>
                            <th width="20%">
                                排序值
                            </th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 编辑模块 modal -->
<div id="moduleModal" class="modal fade" tabindex="-1" data-width="760">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
        <h4 class="modal-title">编辑模块</h4>
    </div>
    <div class="modal-body">
        <form action="#" id="moduleForm" class="form-horizontal">
            <div class="form-body">
                <div class="form-group  margin-top-20">
                    <label class="control-label col-md-3">名称
                        <span class="required"> * </span>
                    </label>
                    <div class="col-md-7">
                        <div class="input-icon right">
                            <i class="fa"></i>
                            <input type="hidden" class="form-control" id="id" name="id"/>
                            <input type="text" class="form-control" id="label" name="label"/>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label col-md-3">
                        排序值
                    </label>
                    <div class="col-md-7">
                        <div class="input-icon right">
                            <i class="fa"></i>
                            <input type="text" class="form-control" id="order" name="order"/>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn dark btn-outline" data-dismiss="modal">关闭</button>
        <button type="button" class="btn green">修改</button>
    </div>
</div>
<!-- 编辑动作 modal -->
<div id="actionModal" class="modal fade" tabindex="-1" data-width="760">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
        <h4 class="modal-title">编辑动作</h4>
    </div>
    <div class="modal-body">
        <form action="#" id="moduleForm" class="form-horizontal">
            <div class="form-body">
                <div class="form-group  margin-top-20">
                    <label class="control-label col-md-3">名称
                        <span class="required"> * </span>
                    </label>
                    <div class="col-md-7">
                        <div class="input-icon right">
                            <i class="fa"></i>
                            <input type="hidden" class="form-control" id="id" name="id"/>
                            <input type="hidden" class="form-control" id="moduleId" name="moduleId"/>
                            <input type="text" class="form-control" id="label" name="label"/>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label col-md-3">
                        地址
                    </label>
                    <div class="col-md-7">
                        <div class="input-icon right">
                            <i class="fa"></i>
                            <input type="text" class="form-control" id="order" name="order"/>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label col-md-3">
                        排序值
                    </label>
                    <div class="col-md-7">
                        <div class="input-icon right">
                            <i class="fa"></i>
                            <input type="text" class="form-control" id="order" name="order"/>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn dark btn-outline" data-dismiss="modal">关闭</button>
        <button type="button" class="btn green">修改</button>
    </div>
</div>

<script type="text/javascript">
    var ModuleData = {};
    var ActionData = {};
    var selectedModule;
    var selectedAction;
    var ModuleOpt;
    var ActionOpt;
    function loadModuleData() {
        var url = "${ctx}/admin/permission/listModule.do";
        $.ajax({
            url: url,
            success: function (res) {
                if (res.code == 0) {
                    var data = res.result;
                    renderModuleData(data);
                } else {
                    alert("加载数据失败");
                }
            }
        });
    }
    function renderModuleData(data) {
        var tbody = $("#moduleDataTable").find("tbody");
        $(tbody).html("");
        ModuleData = {};
        for (var i in data) {
            var line = data[i];
            ModuleData[line.id] = line;
            var ihtml = "<tr role='row' data-id='" + line.id + "' onclick='selectModule(this)'><td>" + line.label + "</td><td>" + line.order + "</td></tr>";
            $(tbody).append(ihtml);
        }
    }

    function selectModule(self) {
        $(self).parent().find(".active").removeClass("active");
        $(self).addClass("active");
        var moduleId = $(self).data("id");
        selectedModule = ModuleData[moduleId];
        selectedAction = null;
        var url = "${ctx}/admin/permission/listActionByModuleId.do";
        $.ajax({
            url: url,
            type: "post",
            data: {moduleId: moduleId},
            success: function (res) {
                if (res.code == 0) {
                    var data = res.result;
                    renderActionData(data);
                } else {
                    alert("加载数据失败");
                }
            }
        });
    }

    function selectAction(self){
        $(self).parent().find(".active").removeClass("active");
        $(self).addClass("active");
        var actionId = $(self).data("id");
        selectedAction = ModuleData[actionId];
    }

    function renderActionData(data) {
        var tbody = $("#actionDataTable").find("tbody");
        $(tbody).html("");
        ActionData = {};
        for (var i in data) {
            var line = data[i];
            ActionData[line.id] = line;
            var ihtml = "<tr role='row' data-id='" + line.id + "' onclick='selectAction(this)'><td>" + line.label + "</td><td>" + line.action + "</td><td>" + line.desc + "</td><td>" + line.order + "</td></tr>";
            $(tbody).append(ihtml);
        }
    }

    function clearModuleForm(){
        var form = $("#moduleForm");
        $(form).find("[name='id']").val("");
        $(form).find("[name='label']").val("");
        $(form).find("[name='order']").val("");
    }

    function fillModuleForm(data){
        var form = $("#moduleForm");
        $(form).find("[name='id']").val(data.id|"");
        $(form).find("[name='label']").val(data.label|"");
        $(form).find("[name='order']").val(data.order|"");
    }

    function submitModuleForm(){
        var addUrl = "${ctx}/admin/permission/addModule.do";
        var updateUrl = "${ctx}/admin/permission/updateModule.do";
        var url = ModuleOpt=="add"?addUrl:updateUrl;
        //TODO form ajax
    }

    function clearActionForm(){
        var form = $("#actionForm");
        $(form).find("[name='id']").val("");
        $(form).find("[name='label']").val("");
        $(form).find("[name='action']").val("");
        $(form).find("[name='order']").val("");
    }

    function fillActionForm(data){
        var form = $("#actionForm");
        $(form).find("[name='id']").val(data.id|"");
        $(form).find("[name='label']").val(data.label|"");
        $(form).find("[name='action']").val(data.action|"");
        $(form).find("[name='order']").val(data.order|"");
    }

    function submitActionForm(){
        var addUrl = "${ctx}/admin/permission/addAction.do";
        var updateUrl = "${ctx}/admin/permission/updateAction.do";
        var url = "";
        if(ActionOpt=="add"){
            url = addUrl;
        }else{
            url = updateUrl;
        }
        
        //TODO form ajax
        $.ajax({
            url:url,
            type:"post",
            data:data,
            success:function(data){

            }
        });
    }

    function showEditModule(){
        $('#moduleModal').modal('show');
    }
    function showEditAction(){
        $('#actionModal').modal('show');
    }
    function init(){
        regEvent();
        loadModuleData();
    }
    function regEvent(){
        $("#add_module").click(function(){
            ModuleOpt = "add";
            showEditModule();
        });
        $("#update_module").click(function(){
            ModuleOpt = "update";
            if(selectedModule==null){
                layer.msg("请先选择一行数据");
                return;
            }
            //TODO 数据回填
            showEditModule();
        });
        $("#delete_module").click(function(){
            //TODO 删除确认
            var url = "${ctx}/admin/permission/deleteModule.do"
            if(selectedModule==null){
                layer.msg("请先选择一行数据");
                return;
            }
            var moduleId = selectedModule.id;
            //TODO 删除确认
            layer.confirm("确定删除该动作"+ name + "信息吗？请注意，该操作不可恢复", {icon:3, title : '提示'}, function(index){
                //点击确认后的回调函数
                layer.close(index);
                $.ajax({
                    url: url,
                    data: {moduleId: moduleId},
                    type: 'POST',
                    success: function(data) {
                        if(data.code == '0') {
                            layer.msg("删除成功")
                            $this.parents('tr').remove();
                        } else {
                            layer.msg("删除失败")
                        }
                    }
                });
            })
        });
        $("#add_action").click(function(){
            ActionOpt = "add";
            clearActionForm();
            showEditAction();
        });
        $("#update_action").click(function(){
            ActionOpt = "update";
            if(selectedAction==null){
                layer.msg("请先选择一行数据");
                return;
            }
            clearActionForm();
            fillActionForm(selectedAction);
            showEditAction();
        });
        $("#delete_action").click(function(){
            var url = "${ctx}/admin/permission/deleteAction.do";
            if(selectedAction==null){
                layer.msg("请先选择一行数据");
                return;
            }
            var actionId = selectedAction.id;
            //TODO 删除确认
            layer.confirm("确定删除该动作"+ name + "信息吗？请注意，该操作不可恢复", {icon:3, title : '提示'}, function(index){
                //点击确认后的回调函数
                layer.close(index);
                $.ajax({
                    url: url,
                    data: {actionId: actionId},
                    type: 'POST',
                    success: function(data) {
                        if(data.code == '0') {
                            layer.msg("删除成功")
                            $this.parents('tr').remove();
                        } else {
                            layer.msg("删除失败")
                        }
                    }
                });
            })
        });
    }
    jQuery(document).ready(function () {
        init();
    });
</script>
</body>
</html>